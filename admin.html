<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆØµÙŠÙØ§Øª</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        .admin-header {
            background: linear-gradient(135deg, #dc2626, #991b1b) !important;
        }
        .admin-header::before {
            background: linear-gradient(90deg, #dc2626, #f59e0b, #dc2626) !important;
        }
        .admin-badge {
            background: #fef3c7;
            color: #92400e;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-top: 10px;
            display: inline-block;
        }
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .admin-table th,
        .admin-table td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid #e5e7eb;
        }
        .admin-table th {
            background: #f3f4f6;
            font-weight: 600;
        }
        .admin-table tr:hover {
            background: #f9fafb;
        }
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        .password-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .password-modal-content {
            background: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
        }
        .password-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 1em;
            text-align: center;
        }
        .stats-mini {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat-mini {
            background: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-mini-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #1e3a5f;
        }
        .stat-mini-label {
            font-size: 0.85em;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="admin-root">
        <div class="loading-screen">
            <div class="loader"></div>
            <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©...</p>
        </div>
    </div>
    <script src="firebase-config.js"></script>
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        // ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ±Ù‡Ø§
        const ADMIN_PASSWORD = 'admin123';
        
        function AdminPanel() {
            const [authenticated, setAuthenticated] = useState(false);
            const [password, setPassword] = useState('');
            const [passwordError, setPasswordError] = useState('');
            const [specifications, setSpecifications] = useState([]);
            const [loading, setLoading] = useState(true);
            const [alert, setAlert] = useState(null);
            const [filter, setFilter] = useState('all');
            const [searchQuery, setSearchQuery] = useState('');

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
            useEffect(() => {
                const savedAuth = sessionStorage.getItem('adminAuth');
                if (savedAuth === 'true') {
                    setAuthenticated(true);
                }
            }, []);

            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            useEffect(() => {
                if (!authenticated) return;
                
                const specsRef = database.ref('specifications');
                specsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const specsArray = Object.entries(data).map(([id, spec]) => ({
                            id,
                            ...spec
                        }));
                        setSpecifications(specsArray.sort((a, b) => b.timestamp - a.timestamp));
                    } else {
                        setSpecifications([]);
                    }
                    setLoading(false);
                });

                return () => specsRef.off();
            }, [authenticated]);

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
            const handleLogin = (e) => {
                e.preventDefault();
                if (password === ADMIN_PASSWORD) {
                    setAuthenticated(true);
                    sessionStorage.setItem('adminAuth', 'true');
                } else {
                    setPasswordError('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                }
            };

            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            const handleLogout = () => {
                setAuthenticated(false);
                sessionStorage.removeItem('adminAuth');
            };

            // ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆØµÙŠÙ
            const changeStatus = async (specId, newStatus) => {
                try {
                    await database.ref(`specifications/${specId}`).update({ 
                        status: newStatus,
                        statusUpdatedAt: Date.now()
                    });
                    showAlert('success', `ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ "${newStatus === 'confirmed' ? 'Ù…Ø¤ÙƒØ¯' : 'ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©'}"`);
                } catch (error) {
                    showAlert('error', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©');
                }
            };

            // Ø­Ø°Ù ØªÙˆØµÙŠÙ
            const deleteSpec = async (spec) => {
                if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù "${spec.name}"ØŸ`)) return;
                
                try {
                    if (spec.pdfUrl) {
                        await storage.refFromURL(spec.pdfUrl).delete().catch(() => {});
                    }
                    if (spec.wordUrl) {
                        await storage.refFromURL(spec.wordUrl).delete().catch(() => {});
                    }
                    await database.ref(`specifications/${spec.id}`).remove();
                    showAlert('success', 'ØªÙ… Ø­Ø°Ù Ø§Ù„ØªÙˆØµÙŠÙ Ø¨Ù†Ø¬Ø§Ø­');
                } catch (error) {
                    showAlert('error', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù');
                }
            };

            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
            const showAlert = (type, message) => {
                setAlert({ type, message });
                setTimeout(() => setAlert(null), 3000);
            };

            // ÙÙ„ØªØ±Ø© Ø§Ù„ØªÙˆØµÙŠÙØ§Øª
            const filteredSpecs = useMemo(() => {
                return specifications.filter(spec => {
                    const matchesFilter = filter === 'all' || spec.status === filter;
                    const matchesSearch = searchQuery === '' || 
                        spec.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                        spec.college.includes(searchQuery) ||
                        spec.uploaderName.includes(searchQuery);
                    return matchesFilter && matchesSearch;
                });
            }, [specifications, filter, searchQuery]);

            // Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            const stats = useMemo(() => ({
                total: specifications.length,
                pending: specifications.filter(s => s.status === 'pending').length,
                confirmed: specifications.filter(s => s.status === 'confirmed').length,
            }), [specifications]);

            // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
            const formatDate = (timestamp) => {
                return new Date(timestamp).toLocaleDateString('ar-SA', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            };

            // Ù†Ø§ÙØ°Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
            if (!authenticated) {
                return (
                    <div className="password-modal">
                        <div className="password-modal-content">
                            <div style={{ fontSize: '3em', marginBottom: '15px' }}>ğŸ”</div>
                            <h2 style={{ marginBottom: '10px' }}>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
                            <p style={{ color: '#666', marginBottom: '20px' }}>Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
                            <form onSubmit={handleLogin}>
                                <input
                                    type="password"
                                    className="password-input"
                                    placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
                                    value={password}
                                    onChange={(e) => {
                                        setPassword(e.target.value);
                                        setPasswordError('');
                                    }}
                                    autoFocus
                                />
                                {passwordError && (
                                    <div style={{ color: '#dc2626', marginBottom: '15px' }}>
                                        âŒ {passwordError}
                                    </div>
                                )}
                                <button type="submit" className="btn btn-primary" style={{ width: '100%' }}>
                                    Ø¯Ø®ÙˆÙ„
                                </button>
                            </form>
                            <a href="index.html" style={{ display: 'block', marginTop: '20px', color: '#666' }}>
                                â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                            </a>
                        </div>
                    </div>
                );
            }

            return (
                <div className="app-container fade-in">
                    {alert && (
                        <div className={`alert-box alert-${alert.type}`}>
                            <span>{alert.type === 'success' ? 'âœ…' : 'âŒ'}</span>
                            <span>{alert.message}</span>
                        </div>
                    )}

                    <header className="header admin-header">
                        <div className="header-logo">ğŸ›¡ï¸</div>
                        <h1 style={{ color: 'white' }}>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
                        <p style={{ color: 'rgba(255,255,255,0.9)' }}>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙˆØµÙŠÙØ§Øª ÙˆØªØ£ÙƒÙŠØ¯Ù‡Ø§</p>
                        <div className="admin-badge">âš ï¸ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø´Ø±Ù</div>
                    </header>

                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                        <a href="index.html" className="btn btn-outline">
                            â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ÙˆÙ‚Ø¹
                        </a>
                        <button onClick={handleLogout} className="btn btn-danger">
                            ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                        </button>
                    </div>

                    <div className="stats-mini">
                        <div className="stat-mini">
                            <div className="stat-mini-value">{stats.total}</div>
                            <div className="stat-mini-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙˆØµÙŠÙØ§Øª</div>
                        </div>
                        <div className="stat-mini">
                            <div className="stat-mini-value" style={{ color: '#f59e0b' }}>{stats.pending}</div>
                            <div className="stat-mini-label">ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
                        </div>
                        <div className="stat-mini">
                            <div className="stat-mini-value" style={{ color: '#10b981' }}>{stats.confirmed}</div>
                            <div className="stat-mini-label">Ù…Ø¤ÙƒØ¯</div>
                        </div>
                    </div>

                    <div className="card">
                        <div className="card-header">
                            <h3 className="card-title">ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙˆØµÙŠÙØ§Øª</h3>
                        </div>

                        <div style={{ display: 'flex', gap: '15px', marginBottom: '20px', flexWrap: 'wrap' }}>
                            <input
                                type="text"
                                className="form-input"
                                placeholder="ğŸ” Ø¨Ø­Ø«..."
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                style={{ flex: 1, minWidth: '200px' }}
                            />
                            <select
                                className="form-select"
                                value={filter}
                                onChange={(e) => setFilter(e.target.value)}
                            >
                                <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                                <option value="pending">ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                                <option value="confirmed">Ù…Ø¤ÙƒØ¯</option>
                            </select>
                        </div>

                        {loading ? (
                            <div style={{ textAlign: 'center', padding: '40px' }}>
                                <div className="loader" style={{ margin: '0 auto' }}></div>
                            </div>
                        ) : (
                            <div style={{ overflowX: 'auto' }}>
                                <table className="admin-table">
                                    <thead>
                                        <tr>
                                            <th>Ø§Ù„ØªÙˆØµÙŠÙ</th>
                                            <th>Ø§Ù„ÙƒÙ„ÙŠØ© / Ø§Ù„Ù‚Ø³Ù…</th>
                                            <th>Ø§Ù„Ø±Ø§ÙØ¹</th>
                                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredSpecs.map(spec => (
                                            <tr key={spec.id}>
                                                <td>
                                                    <div style={{ fontWeight: 600 }}>{spec.name}</div>
                                                    <div style={{ fontSize: '0.85em', color: '#666' }}>
                                                        {spec.type === 'program' ? 'ğŸ“‹ Ø¨Ø±Ù†Ø§Ù…Ø¬' : 'ğŸ“ Ù…Ù‚Ø±Ø±'}
                                                    </div>
                                                </td>
                                                <td>
                                                    <div>{spec.college}</div>
                                                    <div style={{ fontSize: '0.85em', color: '#666' }}>{spec.department}</div>
                                                </td>
                                                <td>
                                                    <div>{spec.uploaderName}</div>
                                                    <div style={{ fontSize: '0.85em', color: '#666' }}>{spec.uploaderDepartment}</div>
                                                </td>
                                                <td>{formatDate(spec.timestamp)}</td>
                                                <td>
                                                    <span className={`status-badge ${spec.status === 'confirmed' ? 'status-confirmed' : 'status-pending'}`}>
                                                        {spec.status === 'confirmed' ? 'âœ“ Ù…Ø¤ÙƒØ¯' : 'â³ ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©'}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div className="action-buttons">
                                                        {spec.status === 'pending' ? (
                                                            <button 
                                                                className="btn btn-success btn-sm"
                                                                onClick={() => changeStatus(spec.id, 'confirmed')}
                                                            >
                                                                âœ“ ØªØ£ÙƒÙŠØ¯
                                                            </button>
                                                        ) : (
                                                            <button 
                                                                className="btn btn-warning btn-sm"
                                                                onClick={() => changeStatus(spec.id, 'pending')}
                                                            >
                                                                â†© Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ£ÙƒÙŠØ¯
                                                            </button>
                                                        )}
                                                        <button 
                                                            className="btn btn-danger btn-sm"
                                                            onClick={() => deleteSpec(spec)}
                                                        >
                                                            ğŸ—‘ï¸
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                {filteredSpecs.length === 0 && (
                                    <div className="empty-state">
                                        <div className="empty-state-icon">ğŸ“­</div>
                                        <div className="empty-state-title">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙˆØµÙŠÙØ§Øª</div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    <footer className="footer">
                        <p>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆØµÙŠÙØ§Øª - Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø·Ø§Ø¦Ù</p>
                    </footer>
                </div>
            );
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        const rootEl = document.getElementById('admin-root');
        if (rootEl) {
            ReactDOM.createRoot(rootEl).render(<AdminPanel />);
        }
    </script>
</body>
</html>
